import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { initializeApp } from 'firebase/app';
import { getFirestore, doc, onSnapshot, setDoc, arrayUnion, arrayRemove } from 'firebase/firestore';
import { Home, ListPlus, ListMinus, Zap, User, Play, Clock, ChevronDown, List as ListIcon } from 'lucide-react';

// --- Global Variables (Provided by Canvas Environment) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Mock Episode Data ---
// ERROR FIX: YouTube Player Error 150 indicates that the video is not set to allow embedding.
// We are replacing all mock ytIds with a known, publicly embeddable placeholder ID to fix the issue.
const EMBEDDABLE_YT_ID = "2g811Eo7K8U"; // Placeholder for an embeddable video

const MOCK_EPISODE_DATA = [
    { id: 'ep_s03e05', season: 3, episode: 5, title: "The Senior Prank Disaster", description: "The crew attempts the biggest prank in school history, but Jane accidentally films the whole thing on live TV.", duration: "24 min", ytId: EMBEDDABLE_YT_ID, thumbnail: "https://placehold.co/800x450/A366FF/ffffff?text=S03+E05+NEW" },
    { id: 'ep_s03e04', season: 3, episode: 4, title: "Cafeteria Chaos", description: "Joe tries to negotiate a better lunch menu with Principal Davies, leading to a surprisingly dramatic food fight.", duration: "22 min", ytId: EMBEDDABLE_YT_ID, thumbnail: "https://placehold.co/800x450/205A28/ffffff?text=S03+E04" },
    { id: 'ep_s03e03', season: 3, episode: 3, title: "The Substitute Teacher", description: "A popular substitute teacher takes over the show for a day, forcing the hosts to become contestants in their own quiz show.", duration: "25 min", ytId: EMBEDDABLE_YT_ID, thumbnail: "https://placehold.co/800x450/970747/ffffff?text=S03+E03" },
    { id: 'ep_s02e08', season: 2, episode: 8, title: "Talent Show Tryouts", description: "Highlights and bloopers from the disastrous school talent show tryouts.", duration: "20 min", ytId: EMBEDDABLE_YT_ID, thumbnail: "https://placehold.co/800x450/A8D5E3/000000?text=S02+E08+FINALE" },
    { id: 'ep_s01e01', season: 1, episode: 1, title: "Pilot", description: "The hosts analyze the week's biggest, and most pointless, drama on campus.", duration: "23 min", ytId: EMBEDDABLE_YT_ID, thumbnail: "https://placehold.co/800x450/EF036C/ffffff?text=S02+E07" },
];

const MOST_RECENT_EPISODE = MOCK_EPISODE_DATA[0];

// --- Firebase Hooks ---

/**
 * Custom hook to initialize Firebase and manage authentication state.
 */
const useFirebase = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);

    useEffect(() => {
        if (!firebaseConfig) {
            console.error("Firebase config is missing.");
            setIsAuthReady(true);
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const firebaseAuth = getAuth(app);
            
            setDb(firestore);
            setAuth(firebaseAuth);

            // 1. Authenticate with custom token or anonymously
            const authenticate = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(firebaseAuth, initialAuthToken);
                    } else {
                        await signInAnonymously(firebaseAuth);
                    }
                } catch(e) {
                    console.error("Initial authentication failed:", e);
                }
            };
            authenticate();

            // 2. Set up listener for auth state changes
            const unsubscribe = onAuthStateChanged(firebaseAuth, (user) => {
                const currentUserId = user?.uid || crypto.randomUUID();
                setUserId(currentUserId);
                setIsAuthReady(true);
            });

            return () => unsubscribe();
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            setIsAuthReady(true);
        }
    }, [firebaseConfig]);

    return { db, auth, userId, isAuthReady };
};

/**
 * Custom hook for managing the user's private watchlist data in Firestore ("My List").
 */
const useWatchList = (db, userId, isAuthReady) => {
    const [watchList, setWatchList] = useState([]);

    // Listener for real-time watchlist updates
    useEffect(() => {
        // IMPORTANT: Only proceed if db and userId are defined
        if (!isAuthReady || !db || !userId) return;

        // Private collection path: /artifacts/{appId}/users/{userId}/watchlist
        const collectionPath = `/artifacts/${appId}/users/${userId}/watchlist`;
        const docRefPath = doc(db, collectionPath, 'items');

        const unsubscribe = onSnapshot(docRefPath, (docSnapshot) => {
            if (docSnapshot.exists()) {
                // The 'episodes' field contains the array of episode IDs
                const data = docSnapshot.data();
                setWatchList(data.episodes || []);
            } else {
                // Initialize the document if it doesn't exist
                setWatchList([]);
                setDoc(docRefPath, { episodes: [] }, { merge: true }).catch(err => console.error("Error initializing watchlist:", err));
            }
        }, (error) => {
            console.error("Firestore WatchList snapshot error:", error);
        });

        return () => unsubscribe();
    }, [db, userId, isAuthReady]);

    // Function to toggle an episode in the list
    const toggleWatchList = useCallback(async (episodeId, isAdded) => {
        if (!db || !userId) {
            console.warn("Database not ready or user ID missing.");
            return;
        }

        const collectionPath = `/artifacts/${appId}/users/${userId}/watchlist`;
        const docRefPath = doc(db, collectionPath, 'items');

        try {
            if (isAdded) {
                // Remove the episode
                await setDoc(docRefPath, { episodes: arrayRemove(episodeId) }, { merge: true });
            } else {
                // Add the episode
                await setDoc(docRefPath, { episodes: arrayUnion(episodeId) }, { merge: true });
            }
        } catch (error) {
            console.error("Error toggling watchlist item:", error);
        }
    }, [db, userId]);

    return { watchList, toggleWatchList };
};


// --- Player Utilities ---

/**
 * YouTube IFrame Player Script Loader.
 */
const loadYoutubeScript = (onScriptLoad) => {
    if (window.YT && window.YT.Player) {
        onScriptLoad();
        return;
    }

    if (!document.getElementById('youtube-iframe-api')) {
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        tag.id = 'youtube-iframe-api';
        document.body.appendChild(tag);
    }
    
    window.onYouTubeIframeAPIReady = onScriptLoad;
};

// --- Sub-Components ---

/**
 * Represents a single episode card.
 */
const EpisodeCard = React.memo(({ episode, onSelect, watchList, toggleWatchList }) => {
    const isAdded = watchList.includes(episode.id);

    return (
        <div 
            className="flex-shrink-0 w-40 md:w-64 cursor-pointer group transform hover:scale-[1.03] transition duration-300 rounded-xl"
            onClick={() => onSelect(episode)}
        >
            <div className="relative overflow-hidden rounded-xl shadow-2xl bg-gray-800">
                <img 
                    src={episode.thumbnail}
                    alt={episode.title}
                    className="w-full h-auto object-cover transition duration-300 group-hover:opacity-75"
                    onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/400x225/333333/ffffff?text=Video+Not+Found" }}
                />
                <button 
                    className="absolute top-2 right-2 p-2 rounded-full bg-black/50 hover:bg-black/80 transition duration-150 text-white backdrop-blur-sm"
                    onClick={(e) => {
                        e.stopPropagation(); 
                        toggleWatchList(episode.id, isAdded);
                    }}
                    title={isAdded ? "Remove from My List" : "Add to My List"}
                >
                    {isAdded ? <ListMinus size={18} className="text-red-400" /> : <ListPlus size={18} className="text-white" />}
                </button>
            </div>
            <div className="mt-2 p-1">
                <p className="text-white text-sm font-semibold truncate">{episode.title}</p>
                <p className="text-gray-400 text-xs">{`S${episode.season} E${episode.episode} Â· ${episode.duration}`}</p>
            </div>
        </div>
    );
});

/**
 * Custom Video Player Component (Wraps YouTube IFrame)
 */
const CustomVideoPlayer = ({ episode, onMinimize }) => {
    const playerRef = React.useRef(null);
    const containerId = useMemo(() => `yt-player-${Date.now()}`, []);
    
    const [player, setPlayer] = useState(null);
    const [isPlaying, setIsPlaying] = useState(false);
    const [currentTime, setCurrentTime] = useState(0);
    const [duration, setDuration] = useState(0);
    const [progressInterval, setProgressInterval] = useState(null);
    
    // Function to initialize the player
    const initPlayer = useCallback(() => {
        if (!window.YT) {
            console.error("YouTube API not loaded.");
            return;
        }

        // Destroy existing player if present
        if (playerRef.current && typeof playerRef.current.destroy === 'function') {
             playerRef.current.destroy();
        }

        const newPlayer = new window.YT.Player(containerId, {
            videoId: episode.ytId,
            playerVars: {
                controls: 0, 
                autoplay: 1, 
                modestbranding: 1,
                rel: 0,
            },
            events: {
                onReady: (e) => {
                    setPlayer(e.target);
                    setDuration(e.target.getDuration());
                    e.target.playVideo();
                },
                onStateChange: (e) => {
                    // State constants: 1=Playing, 2=Paused, 0=Ended
                    setIsPlaying(e.data === window.YT.PlayerState.PLAYING);
                    if (e.data === window.YT.PlayerState.PLAYING) {
                        setDuration(e.target.getDuration());
                    }
                },
                onError: (e) => console.error("YouTube Player Error:", e.data),
            },
        });
        playerRef.current = newPlayer;
    }, [episode.ytId, containerId]);

    // 1. Load the YouTube script and initialize player on mount/episode change
    useEffect(() => {
        loadYoutubeScript(initPlayer);

        return () => {
            // Cleanup interval on unmount
            clearInterval(progressInterval);
            if (playerRef.current && typeof playerRef.current.destroy === 'function') {
                 playerRef.current.destroy();
            }
        };
    }, [episode.ytId, initPlayer]);

    // 2. Start/Stop the time update interval based on playback state
    useEffect(() => {
        clearInterval(progressInterval); 

        if (isPlaying && player) {
            const interval = setInterval(() => {
                setCurrentTime(player.getCurrentTime());
            }, 500); 
            setProgressInterval(interval);
        }
        
        return () => clearInterval(progressInterval); 
    }, [isPlaying, player]);


    // Player Control Functions
    const togglePlay = () => {
        if (!player) return;
        if (isPlaying) {
            player.pauseVideo();
        } else {
            player.playVideo();
        }
        setIsPlaying(!isPlaying);
    };

    const handleSeek = (e) => {
        if (!player || !duration) return;
        const seekTime = (Number(e.target.value) / 100) * duration;
        player.seekTo(seekTime, true);
        setCurrentTime(seekTime);
    };
    
    const formatTime = (seconds) => {
        const totalSeconds = Math.round(seconds);
        const minutes = Math.floor(totalSeconds / 60);
        const remainingSeconds = totalSeconds % 60;
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    };

    const progressPercent = duration > 0 ? (currentTime / duration) * 100 : 0;

    return (
        <div className="relative w-full aspect-video rounded-xl overflow-hidden bg-black shadow-2xl">
            <div id={containerId} className="w-full h-full">
                {/* YouTube iframe will be injected here */}
            </div>

            {/* Custom Controls Overlay */}
            <div className={`absolute inset-0 flex items-center justify-center pointer-events-none transition-opacity duration-300 ${isPlaying ? 'opacity-0 hover:opacity-100' : 'opacity-100'}`}>
                <button 
                    className="p-4 rounded-full bg-white/30 hover:bg-white/50 transition duration-200 pointer-events-auto backdrop-blur-sm"
                    onClick={togglePlay}
                    title={isPlaying ? "Pause" : "Play"}
                >
                    <Play fill="white" size={48} className={`transition duration-300`} />
                </button>
            </div>
            
            {/* Control Bar */}
            <div className="absolute bottom-0 left-0 right-0 h-16 bg-black/90 transition-opacity duration-300 opacity-100 p-3 flex items-center space-x-4">
                
                {/* Play/Pause Button */}
                <button 
                    className="text-white p-2 hover:text-pink-400 transition-colors"
                    onClick={togglePlay}
                    title={isPlaying ? "Pause" : "Play"}
                >
                    {isPlaying ? <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg> : <Play fill="currentColor" size={24} />}
                </button>
                
                {/* Time Display */}
                <span className="text-xs font-mono text-gray-300">{formatTime(currentTime)} / {formatTime(duration)}</span>

                {/* Progress Bar (Custom styled range input) */}
                <input
                    type="range"
                    min="0"
                    max="100"
                    value={progressPercent}
                    onChange={handleSeek}
                    className="flex-grow h-2 rounded-full appearance-none cursor-pointer bg-gray-600 [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-[#A366FF] [&::-webkit-slider-thumb]:appearance-none"
                    style={{ background: `linear-gradient(to right, #A366FF 0%, #A366FF ${progressPercent}%, #374151 ${progressPercent}%, #374151 100%)` }}
                />
                
                {/* Minimize Button */}
                <button 
                    className="text-white p-2 hover:text-pink-400 transition-colors"
                    onClick={onMinimize}
                    title="Minimize Player"
                >
                    <ChevronDown size={20} />
                </button>
            </div>
        </div>
    );
};


// --- Main App Component ---
function App() {
    const { db, userId, isAuthReady } = useFirebase();
    const { watchList, toggleWatchList } = useWatchList(db, userId, isAuthReady);

    const [currentPage, setCurrentPage] = useState('home'); // 'home', 'player', 'mylist'
    const [selectedEpisode, setSelectedEpisode] = useState(MOST_RECENT_EPISODE);
    
    // Sort all episodes by season and episode for display
    const sortedEpisodes = useMemo(() => {
        return MOCK_EPISODE_DATA.sort((a, b) => {
            if (a.season !== b.season) return b.season - a.season;
            return b.episode - a.episode;
        });
    }, []);

    // Group episodes by season for the home screen rows
    const episodesBySeason = useMemo(() => {
        return sortedEpisodes.reduce((acc, episode) => {
            const seasonKey = `Season ${episode.season}`;
            if (!acc[seasonKey]) {
                acc[seasonKey] = [];
            }
            acc[seasonKey].push(episode);
            return acc;
        }, {});
    }, [sortedEpisodes]);

    // Filter episodes for "My List" page
    const myListView = useMemo(() => {
        return sortedEpisodes.filter(e => watchList.includes(e.id));
    }, [sortedEpisodes, watchList]);

    // Handlers for navigation and player
    const handleSelectEpisode = useCallback((episode) => {
        setSelectedEpisode(episode);
        setCurrentPage('player');
    }, []);

    const handlePlayerMinimize = useCallback(() => {
        setCurrentPage('home');
    }, []);

    // --- RENDER SECTIONS ---

    const renderHeader = () => (
        <header className="fixed top-0 left-0 right-0 bg-black/90 backdrop-blur-md z-30 shadow-lg p-4 flex justify-between items-center h-16">
            <div className="flex items-center space-x-8">
                <div className="text-2xl md:text-3xl font-extrabold text-white flex items-center">
                    <Zap className="mr-2 text-pink-400" size={28} />
                    HIGH SCHOOL HYPE
                </div>
                <nav className="hidden md:flex space-x-6 text-gray-300">
                    <NavItem title="Home" icon={Home} pageKey="home" currentPage={currentPage} setCurrentPage={setCurrentPage} />
                    <NavItem title="My List" icon={ListIcon} pageKey="mylist" currentPage={currentPage} setCurrentPage={setCurrentPage} />
                    <NavItem title="Latest" icon={Clock} pageKey="player" onClick={() => handleSelectEpisode(MOST_RECENT_EPISODE)} />
                </nav>
            </div>
            <div className="flex items-center space-x-3 text-sm text-gray-400">
                {isAuthReady && userId ? (
                    <div className="hidden sm:block">
                        <User size={16} className="inline mr-1 text-pink-400" />
                        ID: <span className="font-mono text-xs text-indigo-300 break-all">{userId}</span>
                    </div>
                ) : (
                    <span className="text-yellow-500">Loading Auth...</span>
                )}
            </div>
        </header>
    );

    const renderHomePage = () => (
        <div className="pt-16 min-h-screen bg-[#141414] text-white">
            {/* --- Hero Section (Most Recent Episode) --- */}
            <div 
                className="relative w-full aspect-[16/7] md:aspect-[16/6] bg-cover bg-center transition-all duration-500 cursor-pointer group"
                style={{ backgroundImage: `url(${MOST_RECENT_EPISODE.thumbnail})` }}
                onClick={() => handleSelectEpisode(MOST_RECENT_EPISODE)}
            >
                {/* Gradient Overlay for Text Visibility */}
                <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent"></div>
                
                {/* Content */}
                <div className="absolute bottom-0 left-0 p-6 md:p-12 max-w-lg">
                    <p className="text-pink-400 text-sm font-bold uppercase mb-2 flex items-center">
                        <Zap size={16} className="mr-1" /> Just Dropped
                    </p>
                    <h1 className="text-4xl md:text-6xl font-black text-white leading-tight mb-3 transition-colors duration-200 group-hover:text-pink-400 drop-shadow-lg">
                        {MOST_RECENT_EPISODE.title}
                    </h1>
                    <p className="text-gray-300 text-base mb-6 hidden md:block">{MOST_RECENT_EPISODE.description}</p>
                    
                    <div className="flex space-x-4">
                        <button 
                            className="flex items-center bg-white text-black font-bold py-3 px-6 rounded-full hover:bg-gray-200 transition-all shadow-2xl"
                            title="Play Now"
                        >
                            <Play fill="black" size={20} className="mr-2" /> Watch Now
                        </button>
                        <button 
                            className="flex items-center bg-gray-600/70 text-white font-bold py-3 px-6 rounded-full hover:bg-gray-500/90 transition-all shadow-xl backdrop-blur-sm"
                            onClick={(e) => { e.stopPropagation(); toggleWatchList(MOST_RECENT_EPISODE.id, watchList.includes(MOST_RECENT_EPISODE.id)); }}
                            title={watchList.includes(MOST_RECENT_EPISODE.id) ? "Remove from My List" : "Add to My List"}
                        >
                            {watchList.includes(MOST_RECENT_EPISODE.id) ? <ListMinus size={20} className="mr-2 text-red-400" /> : <ListPlus size={20} className="mr-2" />}
                            My List
                        </button>
                    </div>
                </div>
            </div>

            {/* --- Episode Rows (Netflix-Style Carousel) --- */}
            <div className="p-4 md:p-8 space-y-10 pb-20">
                {Object.keys(episodesBySeason).map(seasonKey => (
                    <EpisodeRow 
                        key={seasonKey}
                        title={seasonKey}
                        episodes={episodesBySeason[seasonKey]}
                        onSelect={handleSelectEpisode}
                        watchList={watchList}
                        toggleWatchList={toggleWatchList}
                    />
                ))}
            </div>
        </div>
    );

    const renderPlayerPage = () => (
        <div className="pt-24 p-4 md:p-8 min-h-screen bg-[#141414] text-white">
            <CustomVideoPlayer episode={selectedEpisode} onMinimize={handlePlayerMinimize} />

            <div className="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                {/* Episode Details */}
                <div className="lg:col-span-2">
                    <h2 className="text-4xl font-bold text-pink-400 mb-2">{selectedEpisode.title}</h2>
                    <p className="text-lg text-gray-400 mb-4">{`Season ${selectedEpisode.season} | Episode ${selectedEpisode.episode} | ${selectedEpisode.duration}`}</p>
                    <p className="text-gray-300 text-base leading-relaxed">{selectedEpisode.description}</p>
                    
                    <button 
                        className="mt-6 flex items-center bg-gray-700 text-white font-semibold py-2 px-4 rounded-full hover:bg-gray-600 transition-colors"
                        onClick={() => toggleWatchList(selectedEpisode.id, watchList.includes(selectedEpisode.id))}
                    >
                        {watchList.includes(selectedEpisode.id) ? (
                            <><ListMinus size={18} className="mr-2 text-red-400" /> Remove from My List</>
                        ) : (
                            <><ListPlus size={18} className="mr-2 text-white" /> Add to My List</>
                        )}
                    </button>
                </div>

                {/* Other Episodes */}
                <div className="lg:col-span-1 bg-[#1c1c1c] rounded-xl p-4 shadow-xl">
                    <h3 className="text-2xl font-bold mb-4 border-b border-gray-700 pb-2 text-pink-400">More Episodes</h3>
                    <div className="space-y-3 max-h-96 overflow-y-auto pr-2 scrollbar-hide">
                        {sortedEpisodes
                            .filter(e => e.id !== selectedEpisode.id)
                            .slice(0, 10)
                            .map(episode => (
                                <div 
                                    key={episode.id} 
                                    className="flex items-center space-x-3 p-3 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer"
                                    onClick={() => handleSelectEpisode(episode)}
                                >
                                    <img 
                                        src={episode.thumbnail} 
                                        alt={episode.title} 
                                        className="w-16 h-9 object-cover rounded-md flex-shrink-0"
                                    />
                                    <div>
                                        <p className="text-sm font-semibold truncate text-white">{episode.title}</p>
                                        <p className="text-xs text-gray-400">{`S${episode.season} E${episode.episode}`}</p>
                                    </div>
                                </div>
                            ))
                        }
                    </div>
                </div>
            </div>
        </div>
    );

    const renderMyListPage = () => (
        <div className="pt-24 p-4 md:p-8 min-h-screen bg-[#141414] text-white">
            <h1 className="text-4xl font-bold text-pink-400 mb-8 flex items-center">
                <ListIcon size={32} className="mr-3" /> My List ({myListView.length})
            </h1>
            
            {myListView.length === 0 ? (
                <div className="text-center p-12 bg-gray-800 rounded-xl shadow-inner border border-gray-700">
                    <p className="text-xl text-gray-400">Your list is empty! Add episodes from the Home page using the <ListPlus className="inline mx-1 text-white" size={20} /> icon.</p>
                </div>
            ) : (
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                    {myListView.map(episode => (
                        <div 
                            key={episode.id} 
                            className="bg-[#1c1c1c] rounded-xl overflow-hidden shadow-lg cursor-pointer transform hover:scale-[1.02] transition duration-300 border border-gray-700"
                            onClick={() => handleSelectEpisode(episode)}
                        >
                            <img 
                                src={episode.thumbnail}
                                alt={episode.title}
                                className="w-full h-auto object-cover"
                                onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/400x225/333333/ffffff?text=Video+Not+Found" }}
                            />
                            <div className="p-3">
                                <p className="text-white text-sm font-semibold truncate">{episode.title}</p>
                                <p className="text-gray-400 text-xs">{`S${episode.season} E${episode.episode}`}</p>
                                <button 
                                    className="mt-2 w-full flex items-center justify-center text-xs text-red-400 border border-red-400 py-1 rounded-full hover:bg-red-400 hover:text-white transition-colors font-medium"
                                    onClick={(e) => { e.stopPropagation(); toggleWatchList(episode.id, true); }}
                                >
                                    <ListMinus size={14} className="mr-1" /> Remove
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );

    let content;
    switch (currentPage) {
        case 'player':
            content = renderPlayerPage();
            break;
        case 'mylist':
            content = renderMyListPage();
            break;
        case 'home':
        default:
            content = renderHomePage();
            break;
    }

    return (
        <div className="min-h-screen font-sans antialiased bg-[#141414]">
            <script src="https://cdn.tailwindcss.com"></script>
            {renderHeader()}
            <main>{content}</main>
        </div>
    );
}

// Helper component for navigation links
const NavItem = ({ title, icon: Icon, pageKey, currentPage, setCurrentPage, onClick }) => {
    const isActive = currentPage === pageKey;
    const baseClasses = "flex items-center text-sm font-semibold transition-colors duration-200 cursor-pointer";
    const activeClasses = "text-white border-b-2 border-pink-400";
    const inactiveClasses = "text-gray-400 hover:text-white hover:border-b-2 hover:border-gray-500";

    const handleClick = () => {
        if (onClick) {
            onClick();
        } else if (setCurrentPage) {
            setCurrentPage(pageKey);
        }
    };

    return (
        <div 
            className={`${baseClasses} ${isActive ? activeClasses : inactiveClasses}`}
            onClick={handleClick}
        >
            <Icon size={18} className="mr-1 md:hidden" />
            <span className="py-1">{title}</span>
        </div>
    );
};

// Helper component for the horizontal row of episodes
const EpisodeRow = ({ title, episodes, onSelect, watchList, toggleWatchList }) => (
    <div>
        <h2 className="text-2xl font-bold text-white mb-4 drop-shadow-md">{title}</h2>
        <div className="flex space-x-5 overflow-x-auto p-2 scrollbar-hide">
            {episodes.map(episode => (
                <EpisodeCard 
                    key={episode.id}
                    episode={episode}
                    onSelect={onSelect}
                    watchList={watchList}
                    toggleWatchList={toggleWatchList}
                />
            ))}
        </div>
    </div>
);

// Inject custom style for scrollbar hiding (used in episode rows and more episodes list)
const styleTag = document.createElement('style');
styleTag.innerHTML = `
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .aspect-video { aspect-ratio: 16 / 9; }
`;
document.head.appendChild(styleTag);


export default App;
